!function(e){"use strict";var n="ilgeEditDelete",t="ilgeApplyCancel",i="ilgeCustom",a=function(a,c){c=c||{},a=e(a);var l=function(n){function t(n,t,i){n.append(e("<input>",{type:"hidden",name:t+"-hidden",id:t+"-hidden",value:i}))}function i(e,n){void 0!=e.actionFormatter&&"function"==typeof e.actionFormatter&&e.actionFormatter(n)}function a(e){return n.find("td:nth-child("+e.column+")")}function c(n){return"select"===n.type?e("<select>",{type:n.type,name:n.name,id:n.name,class:n.class}):e("<input>",{type:n.type,name:n.name,id:n.name,class:n.class})}this.textField=function(e){var n=c(e),l=a(e),o=l.html();n.val(o),l.html(n),i(e,n),t(l,e.name,o)},this.numericField=function(e){var n=c(e),l=a(e),o=l.html();n.val(o),i(e,n),l.html(n),t(l,e.name,o)},this.decimalField=function(e){var n=c(e),l=a(e),o=l.html();n.val(o),i(e,n),l.html(n),t(l,e.name,o)},this.boolField=function(e){var n=c(e),i=a(e),l="true"===i.html().toLowerCase();n.val(l),n.attr("checked",l),i.html(n),t(i,e.name,l)},this.dateField=function(e){var n=c(e),l=a(e),o=l.html();n.val(o),i(e,n),l.html(n),t(l,e.name,o)},this.dateTimeField=function(e){var n=c(e),l=a(e),o=l.html();n.val(o),i(e,n),l.html(n),t(l,e.name,o)},this.selectField=function(e){var n=c(e),i=a(e),l=i.html();i.html(n),t(i,e.name,l)}},o=function(e){this.textField=function(n,t){var i=e.find("td:nth-child("+n.column+")"),a=t?i.find("input[name='"+n.name+"-hidden']").val():i.find("input[name="+n.name+"]").val();i.html(a)},this.numericField=function(n,t){var i=e.find("td:nth-child("+n.column+")"),a=t?i.find("input[name='"+n.name+"-hidden']").val():i.find("input[name="+n.name+"]").val();i.html(a)},this.decimalField=function(n,t){var i=e.find("td:nth-child("+n.column+")"),a=t?i.find("input[name='"+n.name+"-hidden']").val():i.find("input[name="+n.name+"]").val();i.html(a)},this.boolField=function(n,t){var i=e.find("td:nth-child("+n.column+")"),a=t?i.find("input[name='"+n.name+"-hidden']").val():i.find("input[name="+n.name+"]").val();i.html(a.toString())},this.dateField=function(n,t){var i=e.find("td:nth-child("+n.column+")"),a=t?i.find("input[name='"+n.name+"-hidden']").val():i.find("input[name="+n.name+"]").val();i.html(a)},this.dateTimeField=function(n,t){var i=e.find("td:nth-child("+n.column+")"),a=t?i.find("input[name='"+n.name+"-hidden']").val():i.find("input[name="+n.name+"]").val();i.html(a)},this.selectField=function(n,t){var i=e.find("td:nth-child("+n.column+")"),a=t?i.find("input[name='"+n.name+"-hidden']").val():i.find("select[name='"+n.name+"'] option:selected").html();i.html(a)}},d=function(n,t){var i={text:"text",numeric:"numeric",decimal:"decimal",bool:"bool",date:"date",datetime:"datetime",select:"select"},a=new l(t),c=new o(t),d=function(n,i){var a=[];n.parameter.loadBy.keys.forEach(function(e){t.find("[name='"+e.from+"']option:selected");e.isInRow?a.push(e.key+"="+t.find("[name='"+e.from+"']").val()):a.push(e.key+"="+t.closest("body").find("[name='"+e.from+"']").val())});var c=r(n.parameter.uri,a.join("&"));e.getJSON(c,function(e){var t=s(e,n);i(t)})},u=function(n,t){e.getJSON(n.parameter.uri,function(e){var i=s(e,n);t(i)})},s=function(e,n){var t=[];return e.forEach(function(e){t.push({value:e[n.parameter.valueField],html:e[n.parameter.textField]})}),t},m=function(e,n){void 0!=e.parameter.loadBy?d(e,n):u(e,n)},f=0,h=function(n){n.forEach(function(n){var i=t.find("td:nth-child("+n.column+")"),a=i.find("input[name='"+n.name+"-hidden']").val(),c=t.find("select[name='"+n.name+"']");console.log("currentField: "+n.name),m(n,function(t){console.log("currentField: "+n.name+" items: "+t.length),t.forEach(function(n){var t=n.html==a;c.append(e("<option>",{value:n.value,html:n.html,selected:t}))})}),f++})},p=function(){var e=n.filter(function(e){return e.type===i.select}),t=e.filter(function(e){return void 0===e.parameter.loadBy}),a=e.filter(function(e){return"object"==typeof e.parameter.loadBy});t.forEach(function(e){e.fieldsToLoad=a.filter(function(n){return n.parameter.loadBy.keys.filter(function(n){return n.from===e.name})})}),h(t)};this.setUpInputsOnRow=function(e){n.forEach(function(e){switch(e.type.toLowerCase()){case i.text:a.textField(e);break;case i.numeric:a.numericField(e);break;case i.decimal:a.decimalField(e);break;case i.bool:a.boolField(e);break;case i.date:a.dateField(e);break;case i.datetime:a.dateTimeField(e);break;case i.select:a.selectField(e)}}),p()},this.setDownInputsOnRow=function(e){n.forEach(function(n){switch(n.type.toLowerCase()){case i.text:c.textField(n,e);break;case i.numeric:c.numericField(n,e);break;case i.decimal:c.decimalField(n,e);break;case i.bool:c.boolField(n,e);break;case i.date:c.dateField(n,e);break;case i.datetime:c.dateTimeField(n,e);break;case i.select:c.selectField(n,e)}})}},r=function(e,n){return e.lastIndexOf("/")==e.length-1?e+"?"+n:e+"/?"+n},u=function(i,a){var c={controller:{uriSave:"",uriUpdate:"",uriDelete:"",messageReturn:function(){}},fields:[]},l=a.fields||c.fields,o=function(){return void 0===l?null:l.filter(function(e){return"buttons"!=e.type&&e.edit===!0})};this.getFieldsButton=function(){return void 0===l?null:l.filter(function(e){return"buttons"==e.type})};var u=function(e){e.find("."+n).toggle(),e.find("."+t).toggle()},s=function(e){if(void 0===l)return null;var n=l.filter(function(e){return e.isKey===!0}),t="",i=0;return n.forEach(function(a){var c=e.find("td:nth-child("+a.column+")").html();t+=a.name+"="+c,i>0&&i<n.length&&(t+="&"),i++}),t};this.addItemInGrid=function(n){e(this).closest("tr")},this.editItemInGrid=function(n){var t=e(this).closest("tr");u(t);var i=o(),a=new d(i,t);a.setUpInputsOnRow()},this.removeItemFromGrid=function(n){var t=e(this).closest("tr"),i=s(t),c=r(a.controller.uriDelete.url,i);e.ajax({method:a.controller.uriDelete.verb,url:c,cache:!1,error:function(e,n,t){a.controller.messageReturn(t)},success:function(e){e.result&&t.remove(),a.controller.messageReturn(e)}})},this.cancelEditOrAddInGrid=function(n){var t=e(this).closest("tr"),i=o(),a=new d(i,t);a.setDownInputsOnRow(!0),u(t)}};this.setUpGrid=function(){var l=new u(a,c),o=l.getFieldsButton(),d=function(c,l){var o=a.find("tbody tr");o.each(function(a){var o=e(this).find("td:nth-child("+l+")"),d=e("<div>",{class:n});c.editDelete.forEach(function(n){d.append(e("<button>",{name:n.name,class:n.class,type:"button"}).append(e("<i>",{class:n.icon})))}),o.append(d);var r=e("<div>",{class:t});c.cancelApply.forEach(function(n){r.append(e("<button>",{name:n.name,class:n.class,type:"button"}).append(e("<i>",{class:n.icon})))}),r.hide(),o.append(r);var u=e("<div>",{class:i});c.custom.forEach(function(n){var t=e("<button>",{name:n.name,class:n.class,type:"button"}),i=e("<i>",{class:n.icon});t.append(i),t.append(n.text),u.append(t),n.showcheck||t.addClass("hide")}),o.append(u)})},r=function(e){var n={apply:"apply",cancel:"cancel",edit:"edit",remove:"remove",custom:"custom"};e.forEach(function(e){var t=a.find("[name='"+e.name+"']");switch(e.type){case n.apply:t.on("click",l.addItemInGrid);break;case n.cancel:t.on("click",l.cancelEditOrAddInGrid);break;case n.edit:t.on("click",l.editItemInGrid);break;case n.remove:t.on("click",l.removeItemFromGrid);break;case n.custom:t.on("click",e.onClick)}})};o.forEach(function(e){d(e.buttons,e.column),r(e.buttons.editDelete),r(e.buttons.cancelApply),r(e.buttons.custom)})}};e.fn.ilge=function(e){var n=new a(this,e);n.setUpGrid()}}(jQuery);